---
description: "Core development standards, reasoning patterns, and AI coding assistance. Includes pattern reuse strategy, TypeScript standards, error handling patterns, extension integration, performance optimization, security, logging, frontend startup protocol, testing, and accessibility. All patterns include @filename references to actual codebase."
alwaysApply: true
---

# Core Development Standards & AI Assistance

## üéØ Purpose
Provides foundational development standards, reasoning patterns, and AI coding optimization for the Kubota Rental Platform.

**IMPORTANT**: For API keys and secrets management, see `api-keys-secrets-management.mdc` - Always use secrets loader functions, never access `process.env` directly!

---

## 1) AI Coding Assistance Optimization

### Quick Reference First
**ALWAYS check these files before starting work:**
- `docs/reference/AI_CODING_REFERENCE.md` - Main coding patterns
- `docs/reference/COMPONENT_INDEX.md` - Existing components
- `docs/reference/API_ROUTES_INDEX.md` - API endpoints
- `docs/reference/QUICK_COMMANDS.md` - Command reference

### Pattern Reuse Strategy
```typescript
// ‚úÖ CORRECT - Check existing patterns first
// 1. Search docs/reference/COMPONENT_INDEX.md for similar components
// 2. Review docs/reference/AI_CODING_REFERENCE.md for established patterns
// 3. Reuse existing components when possible
// 4. Follow import and structure patterns

// Authentication Pattern (From YOUR Codebase)
// See actual implementation: @frontend/src/app/api/bookings/route.ts:133-145
import { createClient } from '@/lib/supabase/server';
const supabase = await createClient();
const { data: { user }, error: authError } = await supabase.auth.getUser();
if (authError || !user) {
  return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
}
```

**Reference actual implementations**:
- Booking creation auth: @frontend/src/app/api/bookings/route.ts:133-145
- Discount code auth: @frontend/src/app/api/discount-codes/validate/route.ts:32-44

---

## 2) TypeScript & Code Quality Standards

### Type Safety First
```typescript
// ‚úÖ CORRECT - Strict typing
import { Database } from '@/../../supabase/types';

interface BookingData {
  equipmentId: string;
  startDate: string;
  endDate: string;
  customerId: string;
}

// ‚ùå WRONG - Using 'any'
const data: any = ...;
```

### Component Architecture
```typescript
// ‚úÖ CORRECT - Single responsibility, clear purpose
'use client';
import { useState } from 'react';

export default function BookingForm() {
  // Component logic focused on ONE thing
  return <form>...</form>;
}

// ‚ùå WRONG - Component doing too much
export default function BookingFormAndListAndStats() { ... }
```

### Error Handling
```typescript
// ‚úÖ CORRECT - Comprehensive error handling (From YOUR Codebase)
// See actual implementation: @frontend/src/app/api/bookings/route.ts:267-299
try {
  const result = await operation();
  if (!result.success) {
    logger.error('Operation failed', {
      component: 'component-name',
      action: 'operation',
      metadata: { ...metadata }
    });
    return { error: 'User-friendly message' };
  }
} catch (error) {
  // IMPORTANT: Logger signature is logger.error('message', context, error) - error LAST
  // Reference: @frontend/src/lib/logger.ts:202-210
  logger.error('Unexpected error', {
    component: 'component-name',
    action: 'error',
    metadata: { error: error instanceof Error ? error.message : String(error) }
  }, error instanceof Error ? error : undefined);
  return { error: 'Something went wrong' };
}

// ‚ùå WRONG - Silent failures
try { await operation(); } catch {}
```

**Reference error handling patterns**:
- API route error handling: @frontend/src/app/api/bookings/route.ts:267-299
- Error handler utility: @frontend/src/lib/error-handler.ts
- Logger signatures: @frontend/src/lib/logger.ts:202-210

---

## 3) Extension Integration

### Error Detection
```bash
# ‚úÖ Use read_lints to check Error Lens diagnostics
# Shows errors inline in code
```

### Code Quality Checks
- **Error Lens**: Check via `read_lints` before committing
- **Code Spell Checker**: Verify no typos in code/comments
- **Todo Tree**: Address TODO/FIXME comments
- **Prettier**: Auto-format on save (enabled)
- **Import Cost**: Monitor bundle size impact

### Pre-Commit Checklist
- [ ] No errors in `read_lints` output
- [ ] No spelling issues flagged
- [ ] TODOs addressed or documented
- [ ] Code formatted with Prettier
- [ ] Imports optimized

---

## 4) Performance Optimization

### Code Splitting & Lazy Loading
```typescript
// ‚úÖ CORRECT - Dynamic imports for large components
import dynamic from 'next/dynamic';

const HeavyChart = dynamic(() => import('@/components/HeavyChart'), {
  loading: () => <Spinner />,
  ssr: false
});
```

### Memoization
```typescript
// ‚úÖ CORRECT - Memoize expensive calculations
const expensiveValue = useMemo(() => {
  return complexCalculation(data);
}, [data]);

// ‚úÖ CORRECT - Memoize callbacks
const handleClick = useCallback(() => {
  performAction(id);
}, [id]);
```

---

## 5) Reasoning & Problem-Solving

### Chain-of-Thought Approach
When solving complex problems:
1. **Decompose** - Break into atomic steps
2. **Analyze** - Consider constraints and requirements
3. **Pattern Match** - Identify similar solved problems
4. **Validate** - Verify solution against requirements
5. **Optimize** - Refine for performance and clarity

### Multi-Perspective Analysis
Consider problems from:
- **Technical**: Implementation feasibility
- **Business**: Value and requirements
- **User**: Experience and usability
- **System**: Performance and scalability

---

## 6) Security & Input Validation

### Server-Side Validation (ALWAYS)
```typescript
// ‚úÖ CORRECT - Validate on server
import { z } from 'zod';
import { sanitizeBookingFormData } from '@/lib/input-sanitizer';

export async function POST(request: NextRequest) {
  const body = await request.json();

  // 1. Sanitize
  const sanitized = sanitizeBookingFormData(body);

  // 2. Validate
  const schema = z.object({
    equipmentId: z.string().uuid(),
    startDate: z.string().datetime()
  });

  const validated = schema.parse(sanitized);

  // 3. Use safely
  await supabase.from('bookings').insert(validated);
}

// ‚ùå WRONG - Trust client data
await supabase.from('bookings').insert(request.body);
```

---

## 7) Logging Standards

### Structured Logging
```typescript
// ‚úÖ CORRECT - Use logger
import { logger } from '@/lib/logger';

logger.info('Booking created', {
  component: 'booking-api',
  action: 'create',
  metadata: { bookingId, customerId }
});

logger.error('Payment failed', {
  component: 'payment-api',
  action: 'payment_error',
  metadata: { reason }
}, error);

// ‚ùå WRONG - Console.log
console.log('Booking created'); // NEVER
```

---

## 8) Frontend Startup Protocol

### Server Startup (MANDATORY)

**See dedicated rules:**
- `@frontend-startup-protocol.mdc` - Critical startup protocol (ALWAYS APPLY)
- `@nextjs-startup-optimization.mdc` - Detailed optimization guide

```bash
# ‚úÖ CORRECT - Use optimized script (recommended)
bash start-frontend-clean.sh

# ‚úÖ CORRECT - Or use pnpm dev (configured to run script)
cd frontend && pnpm dev

# ‚ùå FORBIDDEN - Bypasses optimizations (no port cleanup, no lock handling)
cd frontend && next dev

# ‚ö†Ô∏è INTERNAL USE ONLY - The scripts use 'pnpm next dev' internally
# to avoid infinite loop (pnpm dev ‚Üí script ‚Üí pnpm dev ‚Üí script...)
# Users should NOT call 'pnpm next dev' directly
```

**Why**: The optimized setup provides:
- ‚ö° **70% faster restarts** (3-5s vs 15-20s) with Turbopack caching
- üßπ **Automatic port cleanup** (kills processes on 3000/3001)
- üîÑ **Process cleanup** (terminates existing Next.js)
- üîí **Lock file handling** (removes stale Turbopack locks)
- üíæ **Cache preservation** (keeps Turbopack cache for speed)
- üîÅ **No infinite loops** (scripts call `pnpm next dev` internally)

**Performance:**
- First start: 10-15s
- Restarts: **3-5s** (with Turbopack filesystem cache)

**Reference:** `@STARTUP_OPTIMIZATION.md` for complete documentation

---

## 9) Testing Standards

### Unit Testing
```typescript
// ‚úÖ CORRECT - Test business logic
import { calculateBookingTotal } from '@/lib/booking';

describe('calculateBookingTotal', () => {
  it('calculates daily rate correctly', () => {
    const result = calculateBookingTotal({
      dailyRate: 100,
      days: 5,
      deliveryFee: 50
    });
    expect(result).toBe(550);
  });
});
```

### Browser Testing
```typescript
// ‚úÖ Use test account for automation
const testCredentials = {
  email: 'aitest2@udigit.ca',
  password: 'TestAI2024!@#$'
};

// ‚úÖ Standard login flow
await browser_navigate('http://localhost:3000/auth/signin');
await browser_click('Sign in with email', ref);
await browser_fill_form([
  { name: 'Email Address', value: testCredentials.email },
  { name: 'Password', value: testCredentials.password }
]);
await browser_click('Sign In', ref);
await browser_wait_for('Welcome back');
```

---

## 10) Accessibility Standards

### WCAG AA Compliance
```tsx
// ‚úÖ CORRECT - Semantic HTML + ARIA
<button
  aria-label="Book equipment"
  aria-describedby="booking-help"
  onClick={handleBook}
>
  Book Now
</button>

// ‚úÖ CORRECT - Form labels
<label htmlFor="equipment">Equipment</label>
<select id="equipment" name="equipment">
  <option>Select...</option>
</select>

// ‚ùå WRONG - No accessibility
<div onClick={handleBook}>Book</div>
```

### Keyboard Navigation
- All interactive elements focusable
- Logical tab order
- Visible focus indicators
- Escape to close modals

---

## üîÑ Quick Reference Workflow

### Starting Any Task
1. Check `docs/reference/AI_CODING_REFERENCE.md` for patterns
2. Search `docs/reference/COMPONENT_INDEX.md` for existing components
3. Review `docs/reference/API_ROUTES_INDEX.md` for similar endpoints
4. Use `docs/reference/QUICK_COMMANDS.md` for command reference

### Before Committing
1. Run `read_lints` - Check errors
2. Verify spelling - Code Spell Checker
3. Address TODOs - Todo Tree
4. Format code - Prettier (auto)
5. Test changes - Browser automation or unit tests

### Creating New Components
1. Search existing components first
2. Follow established patterns
3. Use TypeScript strictly
4. Implement error handling
5. Add accessibility features
6. Write tests

---

## üìä Performance Targets

- **Page Load**: < 1s
- **Time to Interactive**: < 2s
- **First Contentful Paint**: < 500ms
- **Transfer Size**: < 100KB initial

---

## ‚úÖ Final Checklist

Every code change must:
- [ ] Follow TypeScript strict mode
- [ ] Include error handling
- [ ] Use structured logging
- [ ] Validate inputs server-side
- [ ] Pass `read_lints` checks
- [ ] Be accessible (WCAG AA)
- [ ] Include tests where appropriate
- [ ] Follow established patterns
- [ ] Use existing components when possible
- [ ] Document complex logic

---

**Remember**:
- üìö **Check reference files first**
- üîç **Reuse existing patterns**
- üõ°Ô∏è **Security is mandatory**
- ‚ö° **Performance matters**
- ‚ôø **Accessibility is built-in**
