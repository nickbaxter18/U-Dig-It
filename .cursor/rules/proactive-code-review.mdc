---
description: "Proactive code review checklist - AI self-reviews all code before presenting to user"
alwaysApply: true
---

# Proactive Code Review

## üéØ Purpose
Automatically review all code before presenting it to the user, catching issues proactively and reducing review cycles.

---

## Review Process

**Before presenting ANY code to user**, I will perform comprehensive self-review across all dimensions:

1. **Security Review** ‚Üí Check for vulnerabilities
2. **Performance Review** ‚Üí Check for bottlenecks
3. **Business Logic Review** ‚Üí Verify correctness
4. **Code Quality Review** ‚Üí Check standards compliance
5. **Accessibility Review** ‚Üí Verify WCAG compliance

**Output Format**: Present code with review summary showing all checks passed.

---

## 1. Security Self-Review

### Checklist

- [ ] **No hardcoded secrets**
  ```typescript
  // ‚ùå WRONG
  const apiKey = 'sk_test_abc123';

  // ‚úÖ CORRECT
  const apiKey = process.env.STRIPE_SECRET_KEY;
  ```

- [ ] **Input validation present** (server-side)
  ```typescript
  // ‚úÖ CORRECT
  const schema = z.object({ equipmentId: z.string().uuid() });
  const validated = schema.parse(body);
  ```

- [ ] **Authentication verified**
  ```typescript
  // ‚úÖ CORRECT
  const { data: { user } } = await supabase.auth.getUser();
  if (!user) return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });
  ```

- [ ] **Authorization checked** (role-based)
  ```typescript
  // ‚úÖ CORRECT
  if (userData.role !== 'admin') {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 });
  }
  ```

- [ ] **RLS enabled** (if database table)
  ```sql
  -- ‚úÖ CORRECT
  ALTER TABLE bookings ENABLE ROW LEVEL SECURITY;
  CREATE POLICY "bookings_select" ON bookings FOR SELECT ...;
  ```

- [ ] **XSS prevention** (React auto-escapes, but check HTML)
  ```typescript
  // ‚úÖ CORRECT - React auto-escapes
  <div>{userInput}</div>

  // ‚úÖ CORRECT - If HTML needed, sanitize
  import DOMPurify from 'dompurify';
  <div dangerouslySetInnerHTML={{ __html: DOMPurify.sanitize(html) }} />
  ```

- [ ] **SQL injection prevented** (parameterized queries)
  ```typescript
  // ‚úÖ CORRECT - Supabase uses parameterized queries
  await supabase.from('bookings').select('*').eq('id', bookingId);
  ```

- [ ] **Rate limiting applied** (API routes)
  ```typescript
  // ‚úÖ CORRECT
  const rateLimitResult = await rateLimit(request, RateLimitPresets.STRICT);
  if (!rateLimitResult.success) {
    return NextResponse.json({ error: 'Too many requests' }, { status: 429 });
  }
  ```

---

## 2. Performance Self-Review

### Checklist

- [ ] **No N+1 queries**
  ```typescript
  // ‚ùå WRONG - N+1 queries
  for (const booking of bookings) {
    const equipment = await getEquipment(booking.equipmentId);
  }

  // ‚úÖ CORRECT - Single query with join
  const { data } = await supabase
    .from('bookings')
    .select('*, equipment:equipmentId(*)')
    .eq('customerId', userId);
  ```

- [ ] **Pagination implemented** (for lists)
  ```typescript
  // ‚úÖ CORRECT
  .range(0, 19)
  .limit(20)
  ```

- [ ] **Indexes exist for filters**
  ```typescript
  // ‚úÖ CORRECT - Uses indexed column
  .eq('customerId', userId) // Has idx_bookings_customer_id
  .eq('status', 'confirmed') // Has idx_bookings_status
  ```

- [ ] **Specific columns selected** (not SELECT *)
  ```typescript
  // ‚úÖ CORRECT
  .select('id, bookingNumber, status, totalAmount')
  ```

- [ ] **Memoization used** (React - expensive calculations)
  ```typescript
  // ‚úÖ CORRECT
  const totalCost = useMemo(() => {
    return calculateBookingTotal(pricingFactors);
  }, [pricingFactors]);
  ```

- [ ] **Dynamic imports** (large components)
  ```typescript
  // ‚úÖ CORRECT
  const HeavyChart = dynamic(() => import('@/components/HeavyChart'), {
    loading: () => <Spinner />,
    ssr: false
  });
  ```

- [ ] **Bundle size checked** (if new dependencies)
  ```bash
  # ‚úÖ CORRECT - Check impact
  pnpm size
  ```

---

## 3. Business Logic Self-Review

### Checklist

- [ ] **Booking dates validated**
  ```typescript
  // ‚úÖ CORRECT
  if (startDate >= endDate) {
    return { error: 'End date must be after start date' };
  }
  if (startDate < new Date()) {
    return { error: 'Start date cannot be in the past' };
  }
  ```

- [ ] **Pricing calculated correctly**
  ```typescript
  // ‚úÖ CORRECT - Order: base ‚Üí discounts ‚Üí add-ons ‚Üí tax
  const baseCost = dailyRate * days;
  const discountedCost = applyLongTermDiscount(baseCost, days);
  const withAddOns = discountedCost + insuranceFee + deliveryFee;
  const subtotal = applyCoupon(withAddOns, coupon);
  const total = subtotal * 1.15; // HST 15%
  ```

- [ ] **HST 15% applied** (Canadian tax)
  ```typescript
  // ‚úÖ CORRECT
  const hst = subtotal * 0.15;
  const total = subtotal + hst;
  ```

- [ ] **Equipment availability checked**
  ```typescript
  // ‚úÖ CORRECT
  const isAvailable = await checkEquipmentAvailability(
    equipmentId,
    startDate,
    endDate
  );
  if (!isAvailable) {
    return { error: 'Equipment not available for selected dates' };
  }
  ```

- [ ] **Seasonal rates applied** (if applicable)
  ```typescript
  // ‚úÖ CORRECT
  const isPeakSeason = isDateInPeakSeason(startDate, endDate);
  const multiplier = isPeakSeason ? 1.15 : 0.85;
  const adjustedRate = dailyRate * multiplier;
  ```

- [ ] **Security deposit calculated** (30% of total)
  ```typescript
  // ‚úÖ CORRECT
  const securityDeposit = total * 0.30;
  ```

---

## 4. Code Quality Self-Review

### Checklist

- [ ] **TypeScript types correct** (no `any`)
  ```typescript
  // ‚úÖ CORRECT
  interface BookingData {
    equipmentId: string;
    startDate: string;
    endDate: string;
  }

  // ‚ùå WRONG
  const data: any = ...;
  ```

- [ ] **Error handling comprehensive**
  ```typescript
  // ‚úÖ CORRECT
  try {
    const result = await operation();
    if (!result.success) {
      logger.error('Operation failed', { metadata });
      return { error: 'User-friendly message' };
    }
  } catch (error) {
    logger.error('Unexpected error', { error }, error);
    return { error: 'Something went wrong' };
  }
  ```

- [ ] **Logging structured** (not console.log)
  ```typescript
  // ‚úÖ CORRECT
  logger.info('Booking created', {
    component: 'booking-api',
    action: 'create',
    metadata: { bookingId, customerId }
  });

  // ‚ùå WRONG
  console.log('Booking created');
  ```

- [ ] **No TODOs/FIXMEs** (or documented)
  ```typescript
  // ‚úÖ CORRECT - Documented TODO
  // TODO: Add caching for equipment list (performance optimization)
  // Issue: https://github.com/.../issues/123

  // ‚ùå WRONG - Undocumented TODO
  // TODO: Fix this later
  ```

- [ ] **Code formatted** (Prettier)
  ```bash
  # ‚úÖ CORRECT - Auto-formats on save
  # Prettier configured in .prettierrc
  ```

- [ ] **Imports optimized** (no unused)
  ```typescript
  // ‚úÖ CORRECT - Only what's needed
  import { useState, useEffect } from 'react';

  // ‚ùå WRONG - Unused imports
  import { useState, useEffect, useMemo, useCallback } from 'react';
  ```

---

## 5. Accessibility Self-Review

### Checklist

- [ ] **Semantic HTML** (not divs for buttons)
  ```tsx
  // ‚úÖ CORRECT
  <button onClick={handleClick}>Submit</button>

  // ‚ùå WRONG
  <div onClick={handleClick}>Submit</div>
  ```

- [ ] **ARIA labels** (for icon buttons, complex UI)
  ```tsx
  // ‚úÖ CORRECT
  <button aria-label="Close dialog" onClick={onClose}>
    <XIcon />
  </button>
  ```

- [ ] **Form labels** (all inputs labeled)
  ```tsx
  // ‚úÖ CORRECT
  <label htmlFor="equipment">Equipment</label>
  <select id="equipment" name="equipment">...</select>
  ```

- [ ] **Keyboard navigation** (all interactive elements focusable)
  ```tsx
  // ‚úÖ CORRECT - Button is focusable by default
  <button onClick={handleClick}>Click me</button>

  // ‚úÖ CORRECT - Custom element needs tabIndex
  <div role="button" tabIndex={0} onKeyDown={handleKeyDown}>
    Custom button
  </div>
  ```

- [ ] **Focus indicators** (visible)
  ```css
  /* ‚úÖ CORRECT */
  button:focus {
    outline: 2px solid blue;
    outline-offset: 2px;
  }
  ```

- [ ] **Color contrast** (WCAG AA: 4.5:1 for text)
  ```tsx
  // ‚úÖ CORRECT - Check with contrast checker
  <p className="text-gray-700">Text on white background</p>
  ```

---

## üìã Review Output Format

### When Presenting Code

I will include a review summary:

```markdown
‚úÖ Self-Review Complete

**Security**: ‚úÖ Validated, authenticated, RLS enabled, rate limited
**Performance**: ‚úÖ Indexed queries, pagination applied, memoized calculations
**Business Logic**: ‚úÖ Pricing correct, dates validated, availability checked
**Code Quality**: ‚úÖ TypeScript strict, error handling complete, structured logging
**Accessibility**: ‚úÖ Semantic HTML, ARIA labels, keyboard navigation

[Code implementation here]
```

### If Issues Found

```markdown
‚ö†Ô∏è Self-Review: Issues Found

**Security**: ‚ö†Ô∏è Missing rate limiting on API route
**Performance**: ‚ö†Ô∏è Using SELECT * without pagination
**Business Logic**: ‚úÖ All checks passed
**Code Quality**: ‚ö†Ô∏è Using `any` type - should be specific interface
**Accessibility**: ‚úÖ All checks passed

**Fixes Applied**:
- Added rate limiting
- Changed to specific columns with pagination
- Created proper TypeScript interface

[Fixed code implementation here]
```

---

## üéØ Review Priorities

### Critical (Must Fix Before Presenting)
- Security vulnerabilities (hardcoded secrets, missing auth)
- SQL injection risks
- Missing RLS on user-facing tables
- Business logic errors (wrong pricing, availability)

### High (Should Fix)
- Performance issues (N+1 queries, missing indexes)
- Missing error handling
- TypeScript `any` types
- Missing accessibility features

### Medium (Nice to Have)
- Code formatting
- Unused imports
- Documentation TODOs

---

## üìä Review Metrics

Track review effectiveness:
- **Issues Caught**: Number of issues found in self-review
- **Issues Fixed**: Number automatically fixed
- **Review Time**: Time spent on review
- **User Feedback**: Issues found by user after review

**Target**: Catch 90%+ of issues before user sees code

---

## ‚úÖ Success Criteria

Code is ready to present when:
- ‚úÖ All critical checks passed
- ‚úÖ All high-priority issues fixed
- ‚úÖ Review summary shows all green
- ‚úÖ Code follows all established patterns

---

**Status**: ‚úÖ Active Proactive Review System
**Review Dimensions**: 5 (Security, Performance, Business, Quality, Accessibility)
**Auto-Fix**: Enabled for common issues
