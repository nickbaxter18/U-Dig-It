# API Keys & Secrets Management

## üéØ Purpose
**CRITICAL RULE**: All API keys and secrets MUST be retrieved through the unified secrets system. Never access `process.env` directly for secrets.

---

## üîí Core Principle

**NEVER do this:**
```typescript
// ‚ùå WRONG - Direct environment variable access
const apiKey = process.env.SENDGRID_API_KEY;
const stripeKey = process.env.STRIPE_SECRET_KEY;
```

**ALWAYS do this:**
```typescript
// ‚úÖ CORRECT - Use secrets loader functions
import { getSendGridApiKey } from '@/lib/secrets/email';
import { getStripeSecretKey, getStripePublishableKey } from '@/lib/stripe/config';

const apiKey = await getSendGridApiKey();
const stripeKey = await getStripeSecretKey();
```

---

## üìã Secrets Priority Order

All secrets follow this priority (automatically handled by loader functions):

1. **Supabase Edge Function secrets** (set via `supabase secrets set`)
   - Available as environment variables in Next.js
   - Example: `EMAIL_API_KEY`, `STRIPE_SECRET_TEST_KEY`

2. **system_config table** (database-stored secrets)
   - Fallback for secrets stored in database
   - Checked via unified `getSecret()` function

3. **Legacy environment variables** (`.env.local` - for local development only)
   - Fallback for backward compatibility
   - Example: `SENDGRID_API_KEY`, `STRIPE_SECRET_KEY`

4. **Development fallback** (non-production only)
   - Placeholder keys for local development
   - Never used in production

---

## üîë Service-Specific Key Retrieval

### Email Service (SendGrid)

**Function**: `getSendGridApiKey()` from `@/lib/secrets/email`

**Usage:**
```typescript
import { getSendGridApiKey } from '@/lib/secrets/email';

// In async function
const apiKey = await getSendGridApiKey();

// Then use with SendGrid
import sgMail from '@sendgrid/mail';
sgMail.setApiKey(apiKey);
```

**Checks for:**
- `EMAIL_API_KEY` (Supabase secrets) - **PRIMARY**
- `SENDGRID_API_KEY` (legacy env var)
- `system_config` table (`EMAIL_API_KEY` key)

**File**: `frontend/src/lib/secrets/email.ts`

---

### Stripe Service

**Functions**:
- `getStripeSecretKey()` - Server-side secret key
- `getStripePublishableKey()` - Client-side publishable key
- `getStripeWebhookSecret()` - Webhook signing secret

**Usage:**
```typescript
import {
  getStripeSecretKey,
  getStripePublishableKey,
  createStripeClient
} from '@/lib/stripe/config';

// Server-side (API routes, server actions)
const secretKey = await getStripeSecretKey();
const stripe = createStripeClient(secretKey);

// Client-side (if needed)
const publishableKey = await getStripePublishableKey();
```

**Checks for:**
- `STRIPE_SECRET_TEST_KEY` or `STRIPE_SECRET_KEY` (Supabase secrets)
- `STRIPE_PUBLIC_TEST_KEY` or `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY` (Supabase secrets)
- `system_config` table (`stripe_secret_key`, `stripe_publishable_key`)
- Legacy env vars (`STRIPE_SECRET_KEY`, `NEXT_PUBLIC_STRIPE_PUBLISHABLE_KEY`)

**File**: `frontend/src/lib/stripe/config.ts`

---

### Other Services

**Unified Secrets Loader**: `getSecret()` from `@/lib/secrets/loader`

**Usage:**
```typescript
import { getSecret } from '@/lib/secrets/loader';

const result = await getSecret('SERVICE_API_KEY', {
  required: true,  // Throw error if not found
  logSource: true, // Log where secret was found
});

if (result?.value) {
  const apiKey = result.value;
  // Use apiKey
}
```

**Checks for:**
1. Supabase Edge Function secrets (`process.env.SERVICE_API_KEY`)
2. Environment variables (`.env.local`)
3. `system_config` table

**File**: `frontend/src/lib/secrets/loader.ts`

---

## üö´ Common Mistakes to Avoid

### Mistake 1: Direct Environment Variable Access
```typescript
// ‚ùå WRONG
const apiKey = process.env.SENDGRID_API_KEY;
if (!apiKey) throw new Error('API key not found');

// ‚úÖ CORRECT
const apiKey = await getSendGridApiKey();
```

### Mistake 2: Not Using Async/Await
```typescript
// ‚ùå WRONG - Secrets loaders are async
const apiKey = getSendGridApiKey(); // Returns Promise!

// ‚úÖ CORRECT
const apiKey = await getSendGridApiKey();
```

### Mistake 3: Hardcoding Fallback Values
```typescript
// ‚ùå WRONG
const apiKey = process.env.SENDGRID_API_KEY || 'hardcoded-key';

// ‚úÖ CORRECT - Let the loader handle fallbacks
const apiKey = await getSendGridApiKey();
```

### Mistake 4: Checking Multiple Env Vars Manually
```typescript
// ‚ùå WRONG
const apiKey = process.env.EMAIL_API_KEY || process.env.SENDGRID_API_KEY;

// ‚úÖ CORRECT - Loader checks all sources
const apiKey = await getSendGridApiKey();
```

---

## üìù Implementation Checklist

When adding a new service that needs API keys:

- [ ] Create a dedicated loader function in `frontend/src/lib/secrets/[service].ts`
- [ ] Use `getSecret()` from unified loader for `system_config` fallback
- [ ] Check Supabase Edge Function secrets first (via `process.env`)
- [ ] Add legacy env var support for backward compatibility
- [ ] Document the function in this rule file
- [ ] Export the function from the service config file
- [ ] Never access `process.env` directly in service code

---

## üîç Debugging Secrets Issues

### Check Secret Sources

If a secret is not found, check in this order:

1. **Supabase Edge Function secrets**
   ```bash
   # List secrets
   supabase secrets list
   ```

2. **system_config table**
   ```sql
   SELECT key, value FROM system_config WHERE key LIKE '%API_KEY%';
   ```

3. **Environment variables** (`.env.local`)
   ```bash
   # Check if env var is set
   echo $EMAIL_API_KEY
   ```

### Logging

All secrets loaders log their source:
```typescript
// Check server logs for:
// "[Secrets] Loaded EMAIL_API_KEY from Supabase Edge Function secrets"
// "[Secrets] Loaded EMAIL_API_KEY from system_config table"
// "[Secrets] Loaded EMAIL_API_KEY from environment variable"
```

---

## üéØ Quick Reference

| Service | Function | File | Primary Secret Name |
|---------|----------|------|---------------------|
| **Email (SendGrid)** | `getSendGridApiKey()` | `@/lib/secrets/email` | `EMAIL_API_KEY` |
| **Stripe Secret** | `getStripeSecretKey()` | `@/lib/stripe/config` | `STRIPE_SECRET_TEST_KEY` |
| **Stripe Publishable** | `getStripePublishableKey()` | `@/lib/stripe/config` | `STRIPE_PUBLIC_TEST_KEY` |
| **Stripe Webhook** | `getStripeWebhookSecret()` | `@/lib/stripe/config` | `STRIPE_WEBHOOK_SECRET` |
| **Generic** | `getSecret(name)` | `@/lib/secrets/loader` | `[name]` |

---

## ‚úÖ Code Review Checklist

When reviewing code that uses API keys:

- [ ] ‚úÖ Uses secrets loader function (not direct `process.env`)
- [ ] ‚úÖ Properly awaits async secret retrieval
- [ ] ‚úÖ Handles errors from secret retrieval
- [ ] ‚úÖ No hardcoded API keys or fallback values
- [ ] ‚úÖ Logs secret source for debugging
- [ ] ‚úÖ Follows service-specific pattern

---

## üö® Critical Rules

1. **NEVER commit secrets to git** - Use Supabase secrets or `system_config` table
2. **NEVER access `process.env` directly** - Always use loader functions
3. **NEVER hardcode API keys** - Use the secrets system
4. **ALWAYS await async secret loaders** - They return Promises
5. **ALWAYS handle errors** - Secrets might not be configured

---

## üìö Related Files

- `frontend/src/lib/secrets/email.ts` - Email API key loader
- `frontend/src/lib/secrets/loader.ts` - Unified secrets loader
- `frontend/src/lib/stripe/config.ts` - Stripe API key loaders
- `frontend/src/lib/email-service.ts` - Email service (uses `getSendGridApiKey()`)
- `frontend/src/lib/sendgrid.ts` - SendGrid wrapper (uses `getSendGridApiKey()`)

---

**Remember**: The secrets system is designed to work seamlessly with Supabase Edge Functions. Always use the loader functions, never access `process.env` directly for secrets!
