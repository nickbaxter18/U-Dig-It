name: QA Scheduled Checks

on:
  schedule:
    - cron: '0 3 * * *' # nightly API/component tests
    - cron: '0 4 * * 1' # weekly Snyk scans (Mondays)
    - cron: '0 5 1 * *' # monthly Supabase advisor review (1st of month)
  workflow_dispatch:

jobs:
  nightly-tests:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && github.event.schedule == '0 3 * * *')
    runs-on: ubuntu-latest
    name: Nightly API & Component Tests

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run API route tests
        run: |
          cd frontend
          pnpm test:api

      - name: Run component test suite
        run: |
          cd frontend
          pnpm test:components

      - name: Generate coverage summary
        run: |
          cd frontend
          pnpm vitest src/app/api/__tests__ src/components/__tests__ --coverage --run

      - name: Evaluate coverage delta
        run: |
          cd frontend
          pnpm coverage:delta

      - name: Upload Vitest reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-vitest-results
          path: |
            frontend/vitest-report.*.json
            frontend/vitest-report.*.html
          if-no-files-found: ignore

  weekly-snyk:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && github.event.schedule == '0 4 * * 1')
    runs-on: ubuntu-latest
    name: Weekly Snyk Scan

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Snyk
        uses: snyk/actions/setup@v1
        with:
          snyk-version: v1.1293.0

      - name: Run Snyk Open Source scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN not configured. Skipping weekly scan."
            exit 0
          fi
          snyk test --all-projects --severity-threshold=medium

      - name: Run Snyk Code scan
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        run: |
          if [ -z "$SNYK_TOKEN" ]; then
            echo "SNYK_TOKEN not configured. Skipping code scan."
            exit 0
          fi
          snyk code test

  monthly-supabase-advisors:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && github.event.schedule == '0 5 1 * *')
    runs-on: ubuntu-latest
    name: Monthly Supabase Advisor Review

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Supabase CLI
        run: npm install -g supabase

      - name: Run Supabase advisor check
        id: supabase_advisor
        env:
          SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
          SUPABASE_PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
        run: |
          if [ -z "$SUPABASE_ACCESS_TOKEN" ] || [ -z "$SUPABASE_PROJECT_REF" ]; then
            echo "Supabase credentials not configured. Skipping advisor review."
            exit 0
          fi

          supabase login --token "$SUPABASE_ACCESS_TOKEN"
          supabase db doctor --project-ref "$SUPABASE_PROJECT_REF" > supabase-advisor-report.txt

      - name: Policy drift detection
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          cd frontend
          pnpm install --frozen-lockfile
          pnpm policy:drift

      - name: Upload Supabase advisor report
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-advisor-report
          path: supabase-advisor-report.txt
          if-no-files-found: ignore

  nightly-stripe-reconciliation:
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'schedule' && github.event.schedule == '0 3 * * *')
    runs-on: ubuntu-latest
    name: Nightly Stripe vs Supabase reconciliation

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run reconciliation script
        working-directory: frontend
        run: pnpm reconcile:stripe
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY }}
          STRIPE_RECON_LOOKBACK_HOURS: 24


