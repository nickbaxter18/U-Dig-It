#!/bin/bash
# .husky/pre-commit
# Enhanced pre-commit hook with Snyk security scanning

. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Pre-commit Quality Gates + Security Scan"
echo "============================================="

# Get staged TypeScript/TSX files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(ts|tsx)$')

if [ -z "$STAGED_FILES" ]; then
  echo "‚úÖ No TypeScript files staged, skipping checks"
  exit 0
fi

# Run lint-staged (prettier + eslint)
echo "üé® Running lint-staged (prettier + eslint)..."
cd frontend && pnpm exec lint-staged

if [ $? -ne 0 ]; then
  echo "‚ùå Linting failed!"
  exit 1
fi

# Type checks
echo "üìù Running type checks..."
cd /home/vscode/U-Dig-It-1/frontend && pnpm run type-check

if [ $? -ne 0 ]; then
  echo "‚ùå Type check failed!"
  exit 1
fi

# Snyk Code Scan (MANDATORY for new code)
echo "üõ°Ô∏è  Running Snyk code scan..."
SNYK_OUTPUT=$(snyk code test /home/vscode/U-Dig-It-1/frontend --severity-threshold=high 2>&1)
SNYK_EXIT=$?

if [ $SNYK_EXIT -ne 0 ]; then
  echo "‚ö†Ô∏è  Snyk found security issues:"
  echo "$SNYK_OUTPUT"
  echo ""
  echo "üö® CRITICAL: Fix security issues before committing!"
  echo "   Run: snyk code test frontend"
  echo ""
  exit 1
fi

echo "ü§ñ Running AI code review..."
echo "Files to review:"
echo "$STAGED_FILES" | sed 's/^/  - /'

# Check for common issues using auto-fix patterns
echo ""
echo "üîç Checking for common issues..."

# Check for console.log statements
CONSOLE_LOGS=$(git diff --cached | grep -E 'console\.(log|debug|warn|error)' || true)
if [ -n "$CONSOLE_LOGS" ]; then
  echo "‚ö†Ô∏è  Found console.* statements. Consider using logger instead."
  echo "$CONSOLE_LOGS" | head -5
  echo ""
fi

# Check for SELECT * usage (performance anti-pattern)
SELECT_STAR=$(git diff --cached | grep -E "\.select\(['\"]\*['\"]\)" || true)
if [ -n "$SELECT_STAR" ]; then
  echo "‚ùå ERROR: SELECT * usage detected. Use specific columns instead."
  echo "   This improves performance and reduces payload size by ~60%."
  echo "   Example: .select('id, name, status') instead of .select('*')"
  echo ""
  echo "$SELECT_STAR" | head -5
  echo ""
  exit 1
fi

# Check for hardcoded secrets
SECRETS=$(git diff --cached | grep -iE '(password|api[_-]?key|secret|token)\s*=\s*[''"][^''"]+[''"]' || true)
if [ -n "$SECRETS" ]; then
  echo "üö® CRITICAL: Found potential hardcoded secrets!"
  echo "$SECRETS"
  echo "Please move to environment variables."
  exit 1
fi

# Check for missing error handling in async functions
# (This is a simple check - could be enhanced)

echo ""
echo "‚úÖ All quality gates passed!"
echo "   ‚úì Lint & Format"
echo "   ‚úì Type Check"
echo "   ‚úì Snyk Security Scan"
echo ""
echo "üí° Tip: Run 'pnpm test' before pushing"
exit 0
