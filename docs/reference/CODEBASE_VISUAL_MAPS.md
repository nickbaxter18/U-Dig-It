# ğŸ—ºï¸ Visual Codebase Maps

**Purpose**: Visual diagrams and maps for understanding U-Dig-It codebase architecture.

**Last Updated**: 2025-01-21

---

## ğŸ“ System Architecture Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        U-Dig-It Platform                         â”‚
â”‚                    (Kubota Rental System)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”
   â”‚ Next.js â”‚          â”‚ Supabase  â”‚        â”‚  Stripe   â”‚
   â”‚Frontend â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  Backend  â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”¤ Payments  â”‚
   â”‚Port 3000â”‚          â”‚PostgreSQL â”‚        â”‚   API     â”‚
   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                     â”‚
        â”‚                â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚                â”‚SendGrid â”‚
        â”‚                â”‚  Email  â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—„ï¸ Database Schema Visualization

### Core Tables Relationships

```mermaid
erDiagram
    users ||--o{ bookings : "creates"
    users {
        uuid id PK
        string email
        string role
        timestamptz created_at
    }

    equipment ||--o{ bookings : "rented_in"
    equipment {
        uuid id PK
        string name
        string category
        string status
        decimal daily_rate
    }

    bookings ||--o| contracts : "has"
    bookings ||--o{ payments : "requires"
    bookings {
        uuid id PK
        uuid customerId FK
        uuid equipmentId FK
        date start_date
        date end_date
        string status
        decimal total_amount
    }

    contracts {
        uuid id PK
        uuid bookingId FK
        string contract_url
        boolean signed
        timestamptz signed_at
    }

    payments {
        uuid id PK
        uuid bookingId FK
        string stripe_payment_intent_id
        decimal amount
        string status
    }

    discount_codes ||--o{ bookings : "applied_to"
    discount_codes {
        uuid id PK
        string code
        string type
        decimal value
        int usage_count
    }
```

### Table Status Flow

```
Equipment Status Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Available â”‚â”€â”€â”€â–ºâ”‚ Reserved  â”‚â”€â”€â”€â–ºâ”‚  Rented  â”‚â”€â”€â”€â–ºâ”‚Maintenance  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â–²                                                   â”‚
      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Booking Status Flow:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pending â”‚â”€â”€â”€â–ºâ”‚ Confirmed â”‚â”€â”€â”€â–ºâ”‚  Active  â”‚â”€â”€â”€â–ºâ”‚ Completed â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚               â”‚               â”‚
     â”‚               â”‚               â”‚
     â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚Cancelled â”‚    â”‚Cancelled â”‚   â”‚Cancelled â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ API Request Flow

### Standard API Route Pattern (8 Steps)

```
Client Request
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: Rate Limiting                                       â”‚
â”‚ â”œâ”€ Check IP/User request count                             â”‚
â”‚ â”œâ”€ If exceeded â†’ 429 Too Many Requests                     â”‚
â”‚ â””â”€ If OK â†’ Continue                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: Request Validation                                  â”‚
â”‚ â”œâ”€ Check Content-Type (application/json)                   â”‚
â”‚ â”œâ”€ Check Request Size (<10KB)                              â”‚
â”‚ â””â”€ If invalid â†’ 400 Bad Request                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: Authentication                                      â”‚
â”‚ â”œâ”€ Extract JWT from cookies                                â”‚
â”‚ â”œâ”€ Verify with Supabase                                    â”‚
â”‚ â””â”€ If invalid â†’ 401 Unauthorized                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: Input Sanitization                                  â”‚
â”‚ â”œâ”€ Strip HTML tags                                         â”‚
â”‚ â”œâ”€ Normalize whitespace                                     â”‚
â”‚ â””â”€ Remove potentially dangerous content                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: Zod Validation                                      â”‚
â”‚ â”œâ”€ Validate field types                                    â”‚
â”‚ â”œâ”€ Check constraints (min/max, patterns)                   â”‚
â”‚ â””â”€ If invalid â†’ 400 Bad Request with details               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: Business Logic                                      â”‚
â”‚ â”œâ”€ Check equipment availability                            â”‚
â”‚ â”œâ”€ Calculate pricing                                        â”‚
â”‚ â”œâ”€ Create booking record                                    â”‚
â”‚ â””â”€ Process payment (if applicable)                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 7: Structured Logging                                  â”‚
â”‚ â”œâ”€ Log success/failure                                     â”‚
â”‚ â”œâ”€ Include metadata (userId, bookingId)                    â”‚
â”‚ â””â”€ Track performance metrics                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 8: Response                                            â”‚
â”‚ â”œâ”€ Format response JSON                                    â”‚
â”‚ â”œâ”€ Set appropriate status code                             â”‚
â”‚ â””â”€ Return to client                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â–¼
                Client Response
```

---

## ğŸ¨ Component Hierarchy

### Application Component Tree

```
App (root layout)
â”‚
â”œâ”€â”€ Providers
â”‚   â”œâ”€â”€ QueryClientProvider (TanStack Query)
â”‚   â”œâ”€â”€ ThemeProvider (Tailwind)
â”‚   â””â”€â”€ ToastProvider (Notifications)
â”‚
â”œâ”€â”€ Navigation
â”‚   â”œâ”€â”€ Logo
â”‚   â”œâ”€â”€ MainMenu
â”‚   â”‚   â”œâ”€â”€ HomeLink
â”‚   â”‚   â”œâ”€â”€ EquipmentLink
â”‚   â”‚   â”œâ”€â”€ BookLink
â”‚   â”‚   â””â”€â”€ AboutLink
â”‚   â”œâ”€â”€ UserMenu (authenticated)
â”‚   â”‚   â”œâ”€â”€ DashboardLink
â”‚   â”‚   â”œâ”€â”€ ProfileLink
â”‚   â”‚   â””â”€â”€ SignOutButton
â”‚   â””â”€â”€ MobileMenu (responsive)
â”‚
â”œâ”€â”€ Public Routes (no auth required)
â”‚   â”‚
â”‚   â”œâ”€â”€ Home (/)
â”‚   â”‚   â”œâ”€â”€ HeroSection
â”‚   â”‚   â”œâ”€â”€ EquipmentShowcase
â”‚   â”‚   â”‚   â”œâ”€â”€ EquipmentCard (repeated)
â”‚   â”‚   â”‚   â””â”€â”€ ViewMoreButton
â”‚   â”‚   â”œâ”€â”€ FeaturesSection
â”‚   â”‚   â””â”€â”€ CallToAction
â”‚   â”‚
â”‚   â”œâ”€â”€ Equipment (/equipment)
â”‚   â”‚   â”œâ”€â”€ FilterBar
â”‚   â”‚   â”œâ”€â”€ EquipmentGrid
â”‚   â”‚   â”‚   â””â”€â”€ EquipmentCard (repeated)
â”‚   â”‚   â””â”€â”€ Pagination
â”‚   â”‚
â”‚   â”œâ”€â”€ Contact (/contact)
â”‚   â”‚   â””â”€â”€ ContactForm
â”‚   â”‚       â”œâ”€â”€ LeadCaptureForm
â”‚   â”‚       â””â”€â”€ SubmitButton
â”‚   â”‚
â”‚   â””â”€â”€ Auth (/auth/*)
â”‚       â”œâ”€â”€ SignIn
â”‚       â”œâ”€â”€ SignUp
â”‚       â””â”€â”€ ResetPassword
â”‚
â”œâ”€â”€ Protected Routes (auth required)
â”‚   â”‚
â”‚   â”œâ”€â”€ Dashboard (/dashboard)
â”‚   â”‚   â”œâ”€â”€ UserDashboard
â”‚   â”‚   â”‚   â”œâ”€â”€ WelcomeBanner
â”‚   â”‚   â”‚   â”œâ”€â”€ BookingSummary
â”‚   â”‚   â”‚   â”œâ”€â”€ BookingList
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ BookingCard (repeated)
â”‚   â”‚   â”‚   â””â”€â”€ QuickActions
â”‚   â”‚   â””â”€â”€ LoadingState
â”‚   â”‚
â”‚   â””â”€â”€ Booking Flow (/book/*)
â”‚       â”œâ”€â”€ EquipmentSelection
â”‚       â”œâ”€â”€ DateSelection
â”‚       â”œâ”€â”€ AddOnsSelection
â”‚       â”œâ”€â”€ PaymentSection
â”‚       â”œâ”€â”€ InsuranceUpload
â”‚       â””â”€â”€ ContractSigning
â”‚
â””â”€â”€ Admin Routes (admin role required)
    â”‚
    â”œâ”€â”€ AdminDashboard (/admin)
    â”‚   â”œâ”€â”€ StatsOverview
    â”‚   â”‚   â”œâ”€â”€ RevenueCard
    â”‚   â”‚   â”œâ”€â”€ BookingsCard
    â”‚   â”‚   â”œâ”€â”€ EquipmentCard
    â”‚   â”‚   â””â”€â”€ CustomersCard
    â”‚   â”œâ”€â”€ RecentActivity
    â”‚   â””â”€â”€ QuickActions
    â”‚
    â”œâ”€â”€ AdminBookings (/admin/bookings)
    â”‚   â”œâ”€â”€ BookingFilters
    â”‚   â”œâ”€â”€ BookingTable
    â”‚   â”‚   â””â”€â”€ BookingRow (repeated)
    â”‚   â””â”€â”€ BookingDetailModal
    â”‚
    â”œâ”€â”€ AdminEquipment (/admin/equipment)
    â”‚   â”œâ”€â”€ EquipmentFilters
    â”‚   â”œâ”€â”€ EquipmentTable
    â”‚   â””â”€â”€ EquipmentEditModal
    â”‚
    â””â”€â”€ AdminContracts (/admin/contracts)
        â”œâ”€â”€ ContractFilters
        â”œâ”€â”€ ContractTable
        â””â”€â”€ ContractViewModal
```

---

## ğŸ” Authentication & Authorization Flow

```
User Action (Page Load/API Call)
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Check Session   â”‚
â”‚ (middleware)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚ Exists? â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚   NO    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Public Route?   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
    â”‚   NO    â”‚â”€â”€â”€â”€â”€â”€â–º Redirect to /auth/signin
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚   YES   â”‚â”€â”€â”€â”€â”€â”€â–º Allow Access
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

    From "Check Session":
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
    â”‚   YES   â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Fetch User Profile  â”‚
    â”‚ (role, permissions) â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Admin Route?â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â”‚   YES   â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Is Admin Role? â”‚
        â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
        â”‚   NO    â”‚â”€â”€â”€â”€â”€â”€â–º 403 Forbidden
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚   YES   â”‚â”€â”€â”€â”€â”€â”€â–º Allow Access
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        From "Admin Route?":
        â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
        â”‚   NO    â”‚â”€â”€â”€â”€â”€â”€â–º Allow Access
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’³ Payment Flow Diagram

```
User Initiates Booking
      â”‚
      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Create Booking Record            â”‚
â”‚    Status: "pending"                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Calculate Total Amount           â”‚
â”‚    - Base rate Ã— days               â”‚
â”‚    - + Add-ons (insurance, etc.)    â”‚
â”‚    - + Delivery fee                 â”‚
â”‚    - + HST (15%)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Create Stripe Payment Intent     â”‚
â”‚    Amount: total_amount (in cents)  â”‚
â”‚    Metadata: { booking_id }         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Return Client Secret to Frontendâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. User Enters Payment Details      â”‚
â”‚    (Stripe Elements)                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Stripe Processes Payment         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
          â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
          â”‚ Success?â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â”‚
          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
          â”‚   YES   â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Stripe Webhook Triggered         â”‚
â”‚    Event: payment_intent.succeeded  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Update Booking Status            â”‚
â”‚    Status: "pending" â†’ "confirmed"  â”‚
â”‚    (Using service role client)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Send Confirmation Email          â”‚
â”‚    Via SendGrid                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚10. Generate Contract                â”‚
â”‚    PDF created & stored in S3       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
      Booking Confirmed!

          From "Success?":
          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
          â”‚   NO    â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Payment Failed                      â”‚
â”‚ - Show error to user                â”‚
â”‚ - Keep booking as "pending"         â”‚
â”‚ - Allow retry                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‚ Directory Structure Visual

```
U-Dig-It/
â”‚
â”œâ”€â”€ frontend/                    # Next.js 16 Application
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ app/                # App Router (Next.js 13+)
â”‚   â”‚   â”‚   â”œâ”€â”€ (auth)/         # Auth group (layout)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ signin/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ signup/
â”‚   â”‚   â”‚   â”œâ”€â”€ (public)/       # Public group (layout)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx    # Home
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ equipment/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ contact/
â”‚   â”‚   â”‚   â”œâ”€â”€ (protected)/    # Protected group (layout)
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ dashboard/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ book/
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/          # Admin routes
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ layout.tsx  # Admin layout
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ page.tsx    # Admin dashboard
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ bookings/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ equipment/
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ contracts/
â”‚   â”‚   â”‚   â””â”€â”€ api/            # API Routes
â”‚   â”‚   â”‚       â”œâ”€â”€ bookings/
â”‚   â”‚   â”‚       â”œâ”€â”€ equipment/
â”‚   â”‚   â”‚       â”œâ”€â”€ stripe/
â”‚   â”‚   â”‚       â””â”€â”€ admin/
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ components/         # React Components
â”‚   â”‚   â”‚   â”œâ”€â”€ admin/         # Admin-specific
â”‚   â”‚   â”‚   â”œâ”€â”€ auth/          # Auth components
â”‚   â”‚   â”‚   â”œâ”€â”€ booking/       # Booking flow
â”‚   â”‚   â”‚   â”œâ”€â”€ contracts/     # Contracts
â”‚   â”‚   â”‚   â”œâ”€â”€ equipment/     # Equipment display
â”‚   â”‚   â”‚   â””â”€â”€ ui/            # Shared UI components
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ lib/               # Utilities & Config
â”‚   â”‚   â”‚   â”œâ”€â”€ supabase/
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ client.ts  # Browser client
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ server.ts  # Server client
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ admin.ts   # Service role client
â”‚   â”‚   â”‚   â”œâ”€â”€ stripe.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ logger.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ rate-limiter.ts
â”‚   â”‚   â”‚   â””â”€â”€ input-sanitizer.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â”œâ”€â”€ hooks/             # Custom React hooks
â”‚   â”‚   â”‚   â”œâ”€â”€ useBooking.ts
â”‚   â”‚   â”‚   â”œâ”€â”€ useEquipment.ts
â”‚   â”‚   â”‚   â””â”€â”€ useAuth.ts
â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€ types/             # TypeScript types
â”‚   â”‚       â”œâ”€â”€ booking.ts
â”‚   â”‚       â”œâ”€â”€ equipment.ts
â”‚   â”‚       â””â”€â”€ user.ts
â”‚   â”‚
â”‚   â””â”€â”€ public/                # Static assets
â”‚       â”œâ”€â”€ images/
â”‚       â”œâ”€â”€ fonts/
â”‚       â””â”€â”€ icons/
â”‚
â”œâ”€â”€ supabase/                  # Database & Backend
â”‚   â”œâ”€â”€ migrations/            # SQL migrations
â”‚   â”œâ”€â”€ functions/             # Edge functions (if any)
â”‚   â””â”€â”€ types.ts               # Generated TypeScript types
â”‚
â”œâ”€â”€ .cursor/                   # Cursor IDE Config
â”‚   â”œâ”€â”€ rules/                 # AI coding rules
â”‚   â”‚   â”œâ”€â”€ *.mdc              # Always applied
â”‚   â”‚   â”œâ”€â”€ auto-reference-*.mdc  # Auto-attached
â”‚   â”‚   â””â”€â”€ archive/           # Archived rules
â”‚   â””â”€â”€ indexing.json          # Indexing config
â”‚
â”œâ”€â”€ docs/                      # Documentation
â”‚   â”œâ”€â”€ reference/             # Quick reference docs
â”‚   â”œâ”€â”€ architecture/          # System architecture
â”‚   â”œâ”€â”€ api/                   # API documentation
â”‚   â””â”€â”€ guides/                # Developer guides
â”‚
â””â”€â”€ scripts/                   # Utility scripts
    â”œâ”€â”€ start-frontend-clean.sh
    â””â”€â”€ deploy-production.sh
```

---

## ğŸ”„ Data Flow: Booking Creation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser   â”‚
â”‚  (Client)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. POST /api/bookings
       â”‚    { equipmentId, startDate, endDate }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Next.js API Route                  â”‚
â”‚   /api/bookings/route.ts             â”‚
â”‚                                      â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ Rate Limit â†’ Validate â†’      â”‚  â”‚
â”‚   â”‚ Authenticate â†’ Sanitize      â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Check availability
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Supabase PostgreSQL                â”‚
â”‚                                      â”‚
â”‚   SELECT * FROM bookings             â”‚
â”‚   WHERE equipment_id = $1            â”‚
â”‚   AND daterange overlaps             â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. Available âœ“
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Calculate Pricing                  â”‚
â”‚   - Base rate Ã— days                 â”‚
â”‚   - + Add-ons                        â”‚
â”‚   - + Delivery fee                   â”‚
â”‚   - + HST (15%)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. Insert booking
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Supabase PostgreSQL                â”‚
â”‚                                      â”‚
â”‚   INSERT INTO bookings               â”‚
â”‚   (customer_id, equipment_id, ...)   â”‚
â”‚   RETURNING id                       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. Booking created
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Update Equipment Status            â”‚
â”‚                                      â”‚
â”‚   UPDATE equipment                   â”‚
â”‚   SET status = 'reserved'            â”‚
â”‚   WHERE id = $1                      â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. Send notifications
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   SendGrid Email                     â”‚
â”‚   - Confirmation to customer         â”‚
â”‚   - Notification to admin            â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 7. Return response
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser (Client)                   â”‚
â”‚   - Show success message             â”‚
â”‚   - Redirect to payment              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Security Layers                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 7: Application Security
â”œâ”€ Input Validation (Zod schemas)
â”œâ”€ Output Sanitization (DOMPurify)
â”œâ”€ CSRF Protection (SameSite cookies)
â””â”€ XSS Prevention (React auto-escaping)

Layer 6: Authentication & Authorization
â”œâ”€ JWT Token Verification (Supabase Auth)
â”œâ”€ Role-Based Access Control (RLS policies)
â”œâ”€ Session Management (Secure cookies)
â””â”€ Password Hashing (bcrypt)

Layer 5: API Security
â”œâ”€ Rate Limiting (IP + User based)
â”œâ”€ Request Size Limits (10KB)
â”œâ”€ Content-Type Validation
â””â”€ CORS Configuration

Layer 4: Database Security
â”œâ”€ Row-Level Security (RLS)
â”œâ”€ Parameterized Queries (SQL injection prevention)
â”œâ”€ Service Role Key Protection
â””â”€ Encrypted Connections (SSL/TLS)

Layer 3: Network Security
â”œâ”€ HTTPS Only (TLS 1.3)
â”œâ”€ Security Headers (CSP, HSTS, etc.)
â”œâ”€ DDoS Protection (Vercel Edge)
â””â”€ Firewall Rules (Supabase)

Layer 2: Infrastructure Security
â”œâ”€ Environment Variable Encryption
â”œâ”€ Secrets Management (Vercel/Supabase)
â”œâ”€ Audit Logging (Supabase logs)
â””â”€ Backup & Recovery

Layer 1: Monitoring & Response
â”œâ”€ Security Scanning (pre-commit)
â”œâ”€ Error Tracking (Structured logging)
â”œâ”€ Incident Response (Emergency protocols)
â””â”€ Performance Monitoring (Alerts)
```

---

## ğŸ“Š State Management Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        Component Renders             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   TanStack Query Hook                â”‚
â”‚   useQuery({                         â”‚
â”‚     queryKey: ['bookings', userId],  â”‚
â”‚     queryFn: fetchBookings           â”‚
â”‚   })                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
          â”‚ Cached? â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â”‚
          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
          â”‚   YES   â”‚â”€â”€â”€â”€â”€â”€â–º Return Cached Data
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
          â”‚   NO    â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Fetch from API                     â”‚
â”‚   GET /api/bookings                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Query Supabase                     â”‚
â”‚   SELECT * FROM bookings             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Cache Result                       â”‚
â”‚   staleTime: 30s                     â”‚
â”‚   cacheTime: 5min                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Render Component with Data         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User Updates Data:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   useMutation({                      â”‚
â”‚     mutationFn: updateBooking        â”‚
â”‚   })                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Optimistic Update (local)          â”‚
â”‚   - Update cache immediately         â”‚
â”‚   - Show loading state               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Send API Request                   â”‚
â”‚   PUT /api/bookings/[id]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
          â”‚ Success?â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â”‚
          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
          â”‚   YES   â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Invalidate & Refetch Queries       â”‚
â”‚   queryClient.invalidateQueries()    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Re-render with Fresh Data          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

          From "Success?":
          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
          â”‚   NO    â”‚
          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Rollback Optimistic Update         â”‚
â”‚   - Restore previous cache state     â”‚
â”‚   - Show error message               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## âœ… Using Visual Maps

### For AI Model

When explaining code:
1. **Reference relevant diagram** for context
2. **Use visual flow** to explain logic
3. **Point to specific nodes** in diagrams

### For Developers

When planning features:
1. **Check architecture diagram** for system overview
2. **Review flow diagrams** for process understanding
3. **Update diagrams** when architecture changes

---

**Status**: âœ… Active Visual Reference
**Maintained By**: Development Team + AI
**Update When**: Architecture changes, new flows added

